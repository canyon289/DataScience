---
title: "Assignment 2"
author: "Ravin"
date: "Friday, September 05, 2014"
output: html_document
---

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache=TRUE)
```

Downloading file for analysis
```{r DownloadFiles, eval = FALSE}
download.file(url = "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2", destfile = "storm.bz2")
```

Load file into storm dataframe
```{r LoadData}
storm = read.csv(bzfile("storm.bz2"))
```

Summarize data by event type and fatality

Define damage function which estimates cost mulipliers for damage cost
```{r DamageFunction}
fdamage = function(x){
  #Set Multipliers
  factorlevel = c("","-","?","+","0","1","2","3","4","5","6","7","8","B","h","H","K","m","M")
  
  #Some of the factor levels were not known and were assumed to be zero
  factormultiplier = c(0,0,0,0,0,1,2,3,4,5,6,7,10^9,100,100,1000,1000,10^6,10^6)
  
  names(factormultiplier) = factorlevel
  return(factormultiplier[[x]])
}
```

Add damage column to table

```{r CostofDamage}

damage <- (storm[["CROPDMG"]]*sapply(storm[["CROPDMGEXP"]],fdamage) 
          +storm[["PROPDMG"]]*sapply(storm[["PROPDMGEXP"]],fdamage))

storm = cbind(storm,damage)
rm(damage)
```

```{r InitialSummary}
library(plyr)
ef = ddply(storm, .(EVTYPE), summarise, fatalities = sum(FATALITIES), injuries = sum(INJURIES), affected = (sum(FATALITIES)+sum(INJURIES)), damage = sum(damage))

ef = ef[order(ef$affected, decreasing = TRUE),]
```

```{r testingchunk}
dfm = melt(data = ef[1:10,], measure.vars = c("fatalities","injuries","affected"))

ggplot(dfm, aes(EVTYPE,value, fill = variable, order=variabl)) + geom_bar(position = "dodge", stat = "identity")

```
```{r testcode}
dat <- read.table(text="
cars    trucks  suvs
1   2   4
3   5   4
6   4   6
4   5   6
9   12  16", header=TRUE, as.is=TRUE)
dat$day <- factor(c("Mo", "Tu", "We", "Th", "Fr"), 
             levels=c("Mo", "Tu", "We", "Th", "Fr"))

library(reshape2)
library(ggplot2)

mdat <- melt(dat, id.vars="day")
head(mdat)
ggplot(mdat, aes(variable, value, fill = day, order=variable)) +
  geom_bar(stat="identity", position="dodge")
```

